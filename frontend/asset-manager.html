<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Fixed Asset Manager — VOS UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="vos.css">
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .modal {
            position: fixed;
            inset: 0;
            display: none;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal.open { display: flex; }
        .drawer {
            position: fixed;
            inset: 0;
            z-index: 40;
            display: none;
        }
        .drawer.open { display: block; }
        .drawer .mask {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        .drawer .panel {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 100%;
            max-width: 450px;
            padding: 1.5rem;
            overflow-y: auto;
        }
        /* Custom prompt modal needs a higher z-index */
        #prompt-modal {
            z-index: 60;
        }
        /* MODIFIED: Added styles for the toast notifications */
        .toast {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateX(100%);
            opacity: 0;
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
    </style>
</head>
<body>
<script>
    // Auth guard for asset-manager (persisted via localStorage)
    (function(){
        try{
            var user = localStorage.getItem('vosUser');
            if(!user){ window.location.replace('index.html'); }
        }catch(e){ window.location.replace('index.html'); }
        window.addEventListener('DOMContentLoaded', function(){
            var logoutBtn = document.getElementById('btn-logout');
            if(logoutBtn){
                logoutBtn.addEventListener('click', function(){
                    try{ localStorage.removeItem('vosUser'); localStorage.removeItem('userId'); }catch(_){ }
                    try{ sessionStorage.removeItem('vosUser'); }catch(_){ }
                    window.location.href = 'index.html';
                });
            }
        });
    })();
</script>

<div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-2"></div>

<header class="vos-header">
    <div class="vos-header-inner">
        <div class="vos-brand">VERTEX</div>
        <div class="flex items-center gap-4">
            <button class="vos-btn-primary text-white font-semibold py-2 px-4 rounded-lg" id="btn-new">+ New Asset</button>
            <button class="vos-btn-secondary text-white font-semibold py-2 px-4 rounded-lg" id="btn-logout">Logout</button>
        </div>
    </div>
</header>

<div>
    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
        <h1 class="text-2xl font-semibold leading-6 text-slate-900">
            Asset & Equipments
        </h1>
    </div>
</div>


<main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
        <div class="vos-card p-6">
            <div class="text-sm text-slate-500">Total Assets</div>
            <div class="text-3xl font-bold text-slate-800" id="stat-total">0</div>
        </div>
        <div class="vos-card p-6">
            <div class="text-sm text-slate-500">Total Value</div>
            <div class="text-3xl font-bold text-slate-800" id="stat-total-cost">₱0.00</div>
        </div>
    </div>

    <div class="vos-card p-4 mb-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <input id="search" placeholder="Search by name, employee, etc." class="w-full px-3 py-2 text-slate-900 border rounded-md" />
            <select id="f-cat" class="w-full px-3 py-2 text-slate-900 border rounded-md"></select>
            <select id="f-class" class="w-full px-3 py-2 text-slate-900 border rounded-md"></select>
            <select id="f-dept" class="w-full px-3 py-2 text-slate-900 border rounded-md"></select>
        </div>
    </div>

    <div class="vos-card overflow-x-auto">
        <table class="w-full text-sm text-left vos-table">
            <thead>
            <tr>
                <th class="px-6 py-3">Item Name</th>
                <th class="px-6 py-3">Item Type</th>
                <th class="px-6 py-3">Item Classification</th>
                <th class="px-6 py-3">Department</th>
            </tr>
            </thead>
            <tbody id="asset-body">
            </tbody>
        </table>
        <div id="no-results" class="text-center py-12 text-slate-500" style="display: none;">
            <h3 class="font-semibold text-lg text-slate-600">No assets found</h3>
            <p>Try adjusting your search or filter criteria.</p>
        </div>
    </div>
</main>

<div class="modal" id="modal">
    <div class="vos-card w-full max-w-4xl m-4">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="modal-title" class="text-lg font-semibold">New Asset</h3>
            <button class="p-2 rounded-full hover:bg-slate-100" onclick="closeModal()">
                <svg class="w-5 h-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708 .708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
            </button>
        </div>
        <form id="asset-form" class="p-4 max-h-[80vh] overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label class="label">Item Name</label><input name="itemName" required class="input"></div>
                    <div>
                        <label class="label">Item Type</label>
                        <div class="flex items-center gap-2">
                            <select name="itemTypeId" required class="input"></select>
                            <button type="button" id="btn-new-type" class="vos-btn-secondary p-2 rounded-full" title="Add New Item Type">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="label">Classification</label>
                        <div class="flex items-center gap-2">
                            <select name="classificationId" required class="input"></select>
                            <button type="button" id="btn-new-class" class="vos-btn-secondary p-2 rounded-full" title="Add New Classification">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="label">Department</label>
                        <select name="departmentId" required class="input"></select>
                    </div>

                    <div><label class="label">Cost (PHP)</label><input type="number" step="0.01" name="totalCost" required class="input"></div>
                    <div><label class="label">Purchase Date</label><input type="date" name="purchaseDate" required class="input"></div>
                    <div><label class="label">Life Span (Years)</label><input type="number" name="lifeSpan" required class="input"></div>
                    <div><label class="label">Condition</label><select name="condition" class="input"><option>Good</option><option>Bad</option><option>Under Maintenance</option><option>Discontinued</option></select></div>

                    <div><label class="label">Employee</label><select name="employeeId" required class="input"></select></div>
                    <div><label class="label">Encoder</label><select name="encoderId" required class="input"></select></div>

                    <input type="hidden" name="employeeName">
                    <input type="hidden" name="encoderName">
                    <input type="hidden" name="itemTypeName">
                    <input type="hidden" name="classificationName">
                    <input type="hidden" name="departmentName">
                </div>
                <div class="md:col-span-1">
                    <label class="label">Image</label>
                    <div class="w-full h-64 border-2 border-dashed rounded-lg flex items-center justify-center bg-slate-50">
                        <img id="image-preview" src="https://placehold.co/400x300/e2e8f0/475569?text=No+Image" class="max-h-full max-w-full object-contain rounded">
                    </div>
                    <input type="file" name="image" id="image-uploader" class="input mt-2" accept="image/*">
                    <input type="hidden" name="imageUrl">
                    <input type="hidden" name="imageData" id="image-data">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" class="vos-btn-secondary py-2 px-4 rounded-lg" onclick="closeModal()">Cancel</button>
                <button type="submit" class="vos-btn-primary text-white font-semibold py-2 px-4 rounded-lg">Save Asset</button>
            </div>
        </form>
    </div>
</div>

<div class="drawer" id="drawer">
    <div class="mask" onclick="closeDrawer()"></div>
    <div class="vos-card panel">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold">Asset Details</h3>
            <button class="p-2 rounded-full hover:bg-slate-100" onclick="closeDrawer()">
                <svg class="w-5 h-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708 .708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
            </button>
        </div>
        <div id="drawer-body" class="space-y-4"></div>
    </div>
</div>

<div class="modal" id="prompt-modal">
    <div class="vos-card w-full max-w-sm m-4">
        <h3 id="prompt-title" class="text-lg font-semibold p-4 border-b">Add New</h3>
        <div class="p-4">
            <label id="prompt-label" class="label">Name</label>
            <input id="prompt-input" class="input">
            <div id="prompt-error" class="text-sm text-[var(--vos-danger)] mt-1" style="display: none;"></div>
        </div>
        <div class="mt-2 p-4 flex justify-end gap-3 bg-slate-50 rounded-b-xl">
            <button type="button" class="vos-btn-secondary py-2 px-4 rounded-lg" id="prompt-cancel">Cancel</button>
            <button type="button" class="vos-btn-primary text-white font-semibold py-2 px-4 rounded-lg" id="prompt-save">Save</button>
        </div>
    </div>
</div>

<script>
    // --- UTILITIES ---
    const peso = n => new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(+n || 0);

    // MODIFIED: Added a toast notification function
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast p-4 rounded-lg shadow-lg text-white font-semibold';
        toast.textContent = message;

        if (type === 'error') {
            toast.classList.add('bg-red-500');
        } else {
            toast.classList.add('bg-green-500');
        }

        container.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        // Animate out and remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }

    // --- STATE ---
    let itemTypes = [];
    let classifications = [];
    let departments = [];
    let assets = [];
    let users = [];
    let editingId = null;

    // --- DOM ELEMENTS ---
    const bodyEl = document.getElementById('asset-body');
    const statTotalEl = document.getElementById('stat-total');
    const statTotalCostEl = document.getElementById('stat-total-cost');
    const modalEl = document.getElementById('modal');
    const formEl = document.getElementById('asset-form');
    const modalTitleEl = document.getElementById('modal-title');
    const drawerEl = document.getElementById('drawer');
    const drawerBodyEl = document.getElementById('drawer-body');
    const noResultsEl = document.getElementById('no-results');
    const searchEl = document.getElementById('search');
    const catFilterEl = document.getElementById('f-cat');
    const deptFilterEl = document.getElementById('f-dept');
    const classFilterEl = document.getElementById('f-class');
    const imagePreviewEl = document.getElementById('image-preview');
    const imageUploaderEl = document.getElementById('image-uploader');
    const promptModalEl = document.getElementById('prompt-modal');
    const promptTitleEl = document.getElementById('prompt-title');
    const promptLabelEl = document.getElementById('prompt-label');
    const promptInputEl = document.getElementById('prompt-input');
    const promptErrorEl = document.getElementById('prompt-error');
    const promptSaveBtn = document.getElementById('prompt-save');
    const promptCancelBtn = document.getElementById('prompt-cancel');
    let currentPromptType = null;

    // --- DATA FETCHING ---
    const API_BASE = window.ASSET_API_BASE || (location.port === '3001' ? '' : 'http://localhost:3001');

    async function fetchAssets() {
        bodyEl.innerHTML = `<tr><td colspan="4" class="text-center py-12">Loading assets...</td></tr>`;
        try {
            const response = await fetch(`${API_BASE}/api/assets`);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            assets = await response.json();
            render();
        } catch (error) {
            console.error("Could not fetch assets:", error);
            bodyEl.innerHTML = `<tr><td colspan="4" class="text-center py-12 text-red-600">Failed to load assets. ${error.message}</td></tr>`;
        }
    }

    async function loadItemTypes() {
        try {
            const response = await fetch(`${API_BASE}/api/item-types`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            itemTypes = await response.json();
        } catch (error) {
            console.error("Could not fetch item types:", error);
            itemTypes = [];
        }
    }

    async function loadDepartments() {
        try {
            const response = await fetch(`${API_BASE}/api/departments`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            departments = await response.json();
        } catch (error) {
            console.error('Could not fetch departments:', error);
            departments = [];
        }
    }

    async function loadClassifications() {
        try {
            const response = await fetch(`${API_BASE}/api/classifications`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            classifications = await response.json();
        } catch (error) {
            console.error('Could not fetch classifications:', error);
            classifications = [];
        }
    }

    async function loadUsers() {
        try {
            const response = await fetch(`${API_BASE}/api/users`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            users = await response.json();
        } catch (error) {
            console.error('Could not fetch users:', error);
            users = [];
        }
    }

    // --- RENDER FUNCTION ---
    function render() {
        const q = searchEl.value.toLowerCase().trim();
        const cat = catFilterEl.value;
        const dept = deptFilterEl.value;
        const classification = classFilterEl.value;

        const filtered = assets.filter(a => {
            const mq = !q || [a.id, a.itemName, a.itemTypeName, a.departmentName, a.employeeName || '', a.itemClassificationName || ''].some(x => String(x).toLowerCase().includes(q));
            const mc = !cat || cat === 'all' || a.itemTypeName === cat;
            const md = !dept || dept === 'all' || a.departmentName === dept;
            const mcl = !classification || classification === 'all' || a.itemClassificationName === classification;
            return mq && mc && md && mcl;
        });

        if (filtered.length === 0) {
            bodyEl.innerHTML = '';
        } else {
            bodyEl.innerHTML = filtered.map(a => `
            <tr class="border-b last:border-0">
              <td class="px-6 py-4 font-medium text-slate-800"><a href="#" class="text-[var(--vos-primary)] hover:underline" onclick="event.preventDefault(); openDrawer('${a.id}')">${a.itemName}</a></td>
              <td class="px-6 py-4">${a.itemTypeName}</td>
              <td class="px-6 py-4">${a.itemClassificationName}</td>
              <td class="px-6 py-4">${a.departmentName || '—'}</td>
            </tr>`).join('');
        }

        noResultsEl.style.display = filtered.length === 0 && assets.length > 0 ? 'block' : 'none';
        statTotalEl.textContent = filtered.reduce((sum, a) => sum + (a.quantity || 0), 0);
        statTotalCostEl.textContent = peso(filtered.reduce((s, a) => s + (a.total || 0), 0));
    }

    function populateDynamicFilters() {
        const typeOptions = itemTypes.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        catFilterEl.innerHTML = '<option value="all">All Item Types</option>' + itemTypes.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
        formEl.elements.itemTypeId.innerHTML = '<option value="">Select...</option>' + typeOptions;

        const deptOptions = departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        deptFilterEl.innerHTML = '<option value="all">All Departments</option>' + departments.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
        formEl.elements.departmentId.innerHTML = '<option value="">Select...</option>' + deptOptions;

        const classOptions = classifications.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        classFilterEl.innerHTML = '<option value="all">All Classifications</option>' + classifications.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        formEl.elements.classificationId.innerHTML = '<option value="">Select...</option>' + classOptions;

        const userOptions = users.map(u => `<option value="${u.userId}">${u.fullName}</option>`).join('');
        formEl.elements.employeeId.innerHTML = '<option value="">Select Employee...</option>' + userOptions;
        formEl.elements.encoderId.innerHTML = '<option value="">Select Encoder...</option>' + userOptions;
    }

    // --- EVENT HANDLERS & ACTIONS ---
    document.getElementById('btn-new').onclick = () => {
        editingId = null;
        formEl.reset();
        imagePreviewEl.src = 'https://placehold.co/400x300/e2e8f0/475569?text=No+Image';
        formEl.elements.imageUrl.value = '';
        formEl.elements.purchaseDate.valueAsDate = new Date();
        modalTitleEl.textContent = 'New Asset';
        modalEl.classList.add('open');
    };

    function openPrompt(type) {
        currentPromptType = type;
        promptTitleEl.textContent = `Add New ${type}`;
        promptLabelEl.textContent = `${type} Name`;
        promptInputEl.value = '';
        promptErrorEl.style.display = 'none';
        promptErrorEl.textContent = '';
        promptSaveBtn.disabled = false;
        promptModalEl.classList.add('open');
        setTimeout(() => { try { promptInputEl.focus(); } catch(_){} }, 0);
    }

    document.getElementById('btn-new-type').onclick = () => openPrompt('Item Type');
    document.getElementById('btn-new-class').onclick = () => openPrompt('Classification');

    promptCancelBtn.onclick = () => {
        if (promptSaveBtn.disabled) return;
        promptModalEl.classList.remove('open');
    };

    promptSaveBtn.onclick = async () => {
        if (!currentPromptType) return;
        const label = currentPromptType;
        const name = String(promptInputEl.value || '').trim();
        promptErrorEl.style.display = 'none';
        promptErrorEl.textContent = '';
        if (!name) {
            promptErrorEl.textContent = `${label} name is required.`;
            promptErrorEl.style.display = 'block';
            return;
        }

        // Check duplicates locally (case-insensitive)
        const exists = (label === 'Item Type'
            ? itemTypes.some(t => String(t.name).toLowerCase() === name.toLowerCase())
            : classifications.some(c => String(c.name).toLowerCase() === name.toLowerCase()));
        if (exists) {
            promptErrorEl.textContent = `${label} already exists.`;
            promptErrorEl.style.display = 'block';
            return;
        }

        promptSaveBtn.disabled = true;
        try {
            const endpoint = label === 'Item Type' ? 'item-types' : 'classifications';
            const resp = await fetch(`${API_BASE}/api/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            if (!resp.ok) {
                const err = await resp.json().catch(() => ({ message: 'Failed to save.' }));
                throw new Error(err.message || 'Failed to save.');
            }
            const created = await resp.json(); // { id, name }

            // Update local state
            if (label === 'Item Type') {
                itemTypes.push(created);
            } else {
                classifications.push(created);
            }
            // Re-render selects/filters
            populateDynamicFilters();
            // Preselect the newly created value on the form
            if (label === 'Item Type') {
                formEl.elements.itemTypeId.value = created.id;
            } else {
                formEl.elements.classificationId.value = created.id;
            }

            promptModalEl.classList.remove('open');
            showToast(`${label} created successfully.`);
        } catch (e) {
            promptErrorEl.textContent = e.message || 'An error occurred while saving.';
            promptErrorEl.style.display = 'block';
        } finally {
            promptSaveBtn.disabled = false;
        }
    };

    formEl.onsubmit = async (e) => {
        e.preventDefault();
        const submitButton = formEl.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';

        try {
            const selectedItemType = itemTypes.find(t => t.id == formEl.elements.itemTypeId.value);
            if (selectedItemType) formEl.elements.itemTypeName.value = selectedItemType.name;

            const selectedClass = classifications.find(c => c.id == formEl.elements.classificationId.value);
            if (selectedClass) formEl.elements.classificationName.value = selectedClass.name;

            const selectedDept = departments.find(d => d.id == formEl.elements.departmentId.value);
            if (selectedDept) formEl.elements.departmentName.value = selectedDept.name;

            const selectedEmployee = users.find(u => u.userId == formEl.elements.employeeId.value);
            if (selectedEmployee) formEl.elements.employeeName.value = selectedEmployee.fullName;

            const selectedEncoder = users.find(u => u.userId == formEl.elements.encoderId.value);
            if (selectedEncoder) formEl.elements.encoderName.value = selectedEncoder.fullName;

            const formData = new FormData(formEl);
            const data = Object.fromEntries(formData.entries());

// === normalize required FKs to integers and add snake_case copies ===
            data.itemTypeId       = (data.itemTypeId === '' ? null : parseInt(data.itemTypeId, 10));
            data.classificationId = (data.classificationId === '' ? null : parseInt(data.classificationId, 10));
            data.departmentId     = (data.departmentId === '' ? null : parseInt(data.departmentId, 10));
            data.employeeId       = (data.employeeId === '' ? null : parseInt(data.employeeId, 10));
            data.encoderId        = (data.encoderId === '' ? null : parseInt(data.encoderId, 10));
            if (data.lifeSpan !== undefined) data.lifeSpan = (data.lifeSpan === '' ? null : parseInt(data.lifeSpan, 10));
            if (data.quantity !== undefined) data.quantity = (data.quantity === '' ? 1 : parseInt(data.quantity, 10));
            if (data.cost !== undefined) data.cost = (data.cost === '' ? null : parseFloat(data.cost));
            if (data.totalCost !== undefined) data.totalCost = (data.totalCost === '' ? null : parseFloat(data.totalCost));
            data.item_type = data.itemTypeId ?? null;
            data.item_classification = data.classificationId ?? null;
// === end normalization ===
            let response;
            if (editingId) {
                response = await fetch(`${API_BASE}/api/items/${editingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                response = await fetch(`${API_BASE}/api/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || 'Failed to save the asset.');
            }

            closeModal();
            await fetchAssets();
            showToast(`Asset ${editingId ? 'updated' : 'created'} successfully.`);

        } catch (error) {
            showToast(error.message, 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Save Asset';
            editingId = null;
        }
    };

    imageUploaderEl.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            // Basic client-side guard against overly large images
            const MAX_BYTES = 20 * 1024 * 1024; // 20 MB
            if (file.size > MAX_BYTES) {
                showToast('Selected image is too large. Please choose an image under 20 MB.', 'error');
                e.target.value = '';
                return;
            }

            const toCompressedDataUrl = (img, mime = 'image/jpeg') => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // Resize keeping aspect ratio, max dimension 1280px
                const maxDim = 1280;
                let { width, height } = img;
                if (width > maxDim || height > maxDim) {
                    if (width > height) {
                        height = Math.round(height * (maxDim / width));
                        width = maxDim;
                    } else {
                        width = Math.round(width * (maxDim / height));
                        height = maxDim;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                // Try progressively lower quality until under target size
                const TARGET_MAX = 800 * 1024; // ~800 KB
                let quality = 0.8;
                let dataUrl = canvas.toDataURL(mime, quality);
                // Safety loop to reduce size if still too large
                while (dataUrl.length > TARGET_MAX * 1.4 && quality > 0.4) { // dataURL is ~1.33x bytes
                    quality -= 0.1;
                    dataUrl = canvas.toDataURL(mime, quality);
                }
                return dataUrl;
            };

            const reader = new FileReader();
            reader.onload = (event) => {
                const tempImg = new Image();
                tempImg.onload = () => {
                    // Prefer JPEG to compress better; fall back to original type if needed
                    const mime = 'image/jpeg';
                    const compressed = toCompressedDataUrl(tempImg, mime);
                    imagePreviewEl.src = compressed;
                    const imageDataInput = document.getElementById('image-data');
                    if (imageDataInput) imageDataInput.value = compressed;
                    formEl.elements.imageUrl.value = compressed;
                };
                tempImg.onerror = () => {
                    // Fallback: use original data URL
                    const imageUrl = event.target.result;
                    imagePreviewEl.src = imageUrl;
                    formEl.elements.imageUrl.value = imageUrl;
                }
                tempImg.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
    };

    window.editAsset = (id) => {
        const asset = assets.find(x => x.id == id);
        if (!asset) return;

        editingId = id;
        closeDrawer();
        formEl.reset();

        formEl.elements.itemName.value = asset.itemName || '';
        formEl.elements.itemTypeId.value = asset.itemTypeId || '';
        formEl.elements.classificationId.value = asset.itemClassificationId || '';
        formEl.elements.departmentId.value = asset.departmentId || '';
        formEl.elements.totalCost.value = asset.costPerItem || '';
        if (asset.dateAcquired) {
            formEl.elements.purchaseDate.value = new Date(asset.dateAcquired).toISOString().split('T')[0];
        }
        formEl.elements.lifeSpan.value = asset.lifeSpan ? asset.lifeSpan / 12 : '';
        const allowedConditions = ['Good','Bad','Under Maintenance','Discontinued'];
        const currentCond = (asset.condition || '').trim();
        formEl.elements.condition.value = allowedConditions.includes(currentCond) ? currentCond : 'Good';
        formEl.elements.employeeId.value = asset.employeeId || '';
        formEl.elements.encoderId.value = asset.encoderId || '';
        formEl.elements.imageUrl.value = asset.itemImage || '';
        imagePreviewEl.src = asset.itemImage || 'https://placehold.co/400x300/e2e8f0/475569?text=No+Image';

        modalTitleEl.textContent = 'Edit Asset';
        modalEl.classList.add('open');
    }

    window.removeAsset = async (id) => {
        if (confirm(`Are you sure you want to delete asset ${id}?`)) {
            try {
                const response = await fetch(`${API_BASE}/api/items/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({ message: 'Server responded with an error.' }));
                    throw new Error(errData.message);
                }
                closeDrawer();
                await fetchAssets();
                showToast('Asset deleted successfully.');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }
    }

    window.closeModal = () => {
        modalEl.classList.remove('open');
        editingId = null;
    }

    window.openDrawer = (id) => {
        const a = assets.find(x => x.id == id);
        if (!a) return;

        drawerBodyEl.innerHTML = `
        <div class="vos-card mb-4">
            <img src="${a.itemImage || 'https://placehold.co/400x300/e2e8f0/475569?text=No+Image'}" class="w-full h-48 object-cover rounded-lg mb-4">
            <div class="text-xl font-bold">${a.itemName}</div>
            <div class="text-sm text-slate-500">ID: ${a.id}</div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            ${DetailCard("Item Type", a.itemTypeName)}
            ${DetailCard("Classification", a.itemClassificationName)}
            ${DetailCard("Department", a.departmentName, true)}
            ${DetailCard("Employee", a.employeeName, true)}
            ${DetailCard("Purchase Date", a.dateAcquired ? new Date(a.dateAcquired).toLocaleDateString() : 'N/A')}
            ${DetailCard("Cost", `<strong class="text-[var(--vos-accent)]">${peso(a.total)}</strong>`)}
            ${DetailCard("Life Span", a.lifeSpan ? `${a.lifeSpan / 12} years` : 'N/A')}
            ${DetailCard("Condition", a.condition)}
            ${DetailCard("Encoder ID", a.encoderId, true)}
        </div>
        <div class="mt-6 flex gap-2">
            <button class='vos-btn-primary text-white font-semibold py-2 px-4 rounded-lg w-full' onclick="editAsset('${a.id}')">Edit</button>
            <button class='vos-btn-danger text-white font-semibold py-2 px-4 rounded-lg w-full' onclick="removeAsset('${a.id}')">Delete</button>
        </div>
      `;
        drawerEl.classList.add('open');
    }
    const DetailCard = (label, value, full = false) => value ? `<div class="vos-card p-3 ${full ? 'col-span-2' : ''}"><div class="text-xs text-slate-500">${label}</div><div class="font-semibold">${value}</div></div>` : '';

    window.closeDrawer = () => {
        drawerEl.classList.remove('open');
    }

    // --- INITIALIZATION ---
    document.querySelectorAll('.label').forEach(el => el.classList.add('block', 'text-sm', 'font-medium', 'text-slate-700', 'mb-1'));
    document.querySelectorAll('.input').forEach(el => el.classList.add('w-full', 'px-3', 'py-2', 'text-slate-900', 'border', 'rounded-md'));

    document.addEventListener('DOMContentLoaded', async () => {
        await Promise.all([
            loadItemTypes(),
            loadDepartments(),
            loadClassifications(),
            loadUsers(),
            fetchAssets()
        ]);
        populateDynamicFilters();
    });
</script>
</body>
</html>